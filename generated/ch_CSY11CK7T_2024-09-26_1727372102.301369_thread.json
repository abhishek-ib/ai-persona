{
  "id": "ch_CSY11CK7T_2024-09-26_1727372102.301369_thread",
  "type": "channel",
  "channel_name": "discuss-frontend",
  "conversation_type": "thread",
  "participants": [
    "Yash Botadra",
    "Xindi Xu",
    "Weiming Wu",
    "Victor Zeng",
    "Serena"
  ],
  "messages": [
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Not yet. I wanted to fix the cypress tests first.",
      "time": "10:35",
      "timestamp": "1727372102.301369",
      "is_reply": false
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Could we migrate it first? A couple tests are failing in the sandbox, but we can't fix it properly because they pass on Crafting Cypress",
      "time": "10:36",
      "timestamp": "1727372172.252739",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "What user are you using to test it?",
      "time": "10:52",
      "timestamp": "1727373156.846079",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "We are creating new users when running crafting cypress tests. The problem is that the UI is different in sandbox (migrated) and crafting cypress (not yet migrated)",
      "time": "10:53",
      "timestamp": "1727373221.653449",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Ok. Then we should be able to unblock you by flipping the feature flag.",
      "time": "10:54",
      "timestamp": "1727373246.899769",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "ty!!",
      "time": "10:54",
      "timestamp": "1727373257.894259",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Feature flag has been flipped.",
      "time": "10:55",
      "timestamp": "1727373340.790529",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "perfect! Thank you!",
      "time": "10:55",
      "timestamp": "1727373350.363739",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Ahh, is it ok to flip the feature flag without migrating users? I'm seeing error toasts with `Metronome customer for support-testing.cypress.drives_instabase.com (http://drives_instabase.com) not found` errors on Crafting Cypress now...",
      "time": "11:54",
      "timestamp": "1727376845.968309",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Let me check if the script has finished.",
      "time": "12:28",
      "timestamp": "1727378902.619389",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "@Victor Zeng any updates on this? This blocks all frontend engs from using Cypress to validate their changes. Would be great to get this done asap :woman-bowing:",
      "time": "14:51",
      "timestamp": "1727387504.240749",
      "is_reply": true
    },
    {
      "sender": "Serena",
      "user_id": "U01CZ3LBFU4",
      "message": "the cypress CI run  (https://cloud.cypress.io/projects/cfhedy/runs/14243/overview/b915eb12-83af-4cfa-a7bc-c7fd234b9d4b/replay?roarHideRunsWithDiffGroupsAndTags=1&runStatus=PASSED&runStatus=FAILED&runStatus=RUNNING&runStatus=CANCELLED&runStatus=ERRORED&runStatus=NOTESTS&runStatus=TIMEDOUT&ts=1727385984514.1&att=1)on my PR failed bc of this - this is expected, right? all cypress CI runs will fail until this is fixed?",
      "time": "15:10",
      "timestamp": "1727388634.926059",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "2000/3000 accounts are migrated.",
      "time": "15:26",
      "timestamp": "1727389603.473909",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "There's about 1000 accounts left.",
      "time": "15:26",
      "timestamp": "1727389617.737679",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "@Victor Zeng @Weiming Wu I see the same issue on sandbox (https://aihub-sandbox.internal.instabase.com/settings/account) when I log in as a newly created user.\nTest account: <mailto:cy-account-user-1727382225563@instabase.com|cy-account-user-1727382225563@instabase.com> / ChangeMe123!",
      "time": "15:45",
      "timestamp": "1727390740.219619",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "I just realized this, but did we mock out the trial-license API call?",
      "time": "15:46",
      "timestamp": "1727390796.150849",
      "is_reply": true
    },
    {
      "sender": "Weiming Wu",
      "user_id": "U03DZ9Y4MC2",
      "message": "What do you mean by mock out? It has been calling the actual endpoint for a long time",
      "time": "15:47",
      "timestamp": "1727390853.909879",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "I tried out creating a new account on sandbox, and it works as expected.",
      "time": "15:48",
      "timestamp": "1727390905.477959",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "",
      "time": "15:48",
      "timestamp": "1727390909.806329",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Yea, same. Probably need to update our script to create new community users & set up their license?",
      "time": "15:49",
      "timestamp": "1727390945.070809",
      "is_reply": true
    },
    {
      "sender": "Weiming Wu",
      "user_id": "U03DZ9Y4MC2",
      "message": "It should set up their license on their first login",
      "time": "15:49",
      "timestamp": "1727390999.237219",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "https://cloud.cypress.io/projects/cfhedy/runs/14241/overview/45dcc2d7-0b05-49cb-833d-[…]rHideRunsWithDiffGroupsAndTags=1&ts=1727381592044.0999&att=1 (https://cloud.cypress.io/projects/cfhedy/runs/14241/overview/45dcc2d7-0b05-49cb-833d-f21e40caf9d7/replay?roarHideRunsWithDiffGroupsAndTags=1&ts=1727381592044.0999&att=1)\n\nFrom the log, I can see that when we log in as a newly created user:\n1. we initialize the license with `api/v2/licenses/trial-license/ai-hub` (IB-Context: cy-landing-user-1727381467211_instabase.com (http://cy-landing-user-1727381467211_instabase.com)), which returns 201\n2. try to get their spend limit by calling: `api/v2/licenses/spend-limit/cy-landing-user-1727381467211_instabase.com` and the response is \n```{\n  \"message\": \"Metronome customer for cy-landing-user-1727381467211_instabase.com (http://cy-landing-user-1727381467211_instabase.com) not found\"\n}```",
      "time": "15:56",
      "timestamp": "1727391414.295969",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Ok. I can reproduce by adding a non-existing user to an org and then remove. Log in as that new user via forgot password flow.\n<mailto:xindi.xu+0926add-and-remove@instabase.com|xindi.xu+0926add-and-remove@instabase.com> / ChangeMe123!\n\nThis is how we create new community users in Cypress",
      "time": "16:00",
      "timestamp": "1727391601.119529",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "As an immediate workaround, I'll mock out the `spend-limit` endpoint so suppress this error.",
      "time": "16:02",
      "timestamp": "1727391777.908509",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Yep. Checked the account integrations.",
      "time": "16:02",
      "timestamp": "1727391778.521489",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "They're both null.",
      "time": "16:03",
      "timestamp": "1727391785.929429",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "For community, stripe and metronome accounts are created upon email verification. Do we skip email verification during cypress?",
      "time": "16:03",
      "timestamp": "1727391826.221519",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "yes, we manually set it to true via api calls.",
      "time": "16:04",
      "timestamp": "1727391853.093919",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "In that case, you'll want to call the `{{base_url}}/api/v2/licenses/migrate` endpoint with site-admin credentials.",
      "time": "16:05",
      "timestamp": "1727391914.150539",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "Payload is\n```{\n    \"public_id\": \"cy-account-user-1727382225563_instabase.com (http://cy-account-user-1727382225563_instabase.com)\"\n}```",
      "time": "16:06",
      "timestamp": "1727391993.536919",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "This will create the accounts in metronome and stripe.",
      "time": "16:07",
      "timestamp": "1727392039.334319",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "(Ideally we would call the endpoint to activate the email instead)",
      "time": "16:07",
      "timestamp": "1727392053.413879",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Hm, init upon email verification seems incorrect to me.\nI added a new user to the org, log in as that new user, and then switched to the community context. (note that no email verification is needed because the user already verified their email when they accepted the org invite). I do see the modal for license creation, but the usage page is not loading for me and I see this in the network tab\n```\"Metronome customer for xindi.xu.0926test3_instabase.com not found\"```\nI don't see the error toast tho.\nEdit: see it now when I switch to the subscription page\n<mailto:xindi.xu+0926test3@instabase.com|xindi.xu+0926test3@instabase.com>/ChangeMe123!",
      "time": "16:12",
      "timestamp": "1727392376.340589",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Now I also got this error :lolcry: when I try to migrate license....\n`\"500 Internal Server Error: The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application`",
      "time": "16:28",
      "timestamp": "1727393298.522049",
      "is_reply": true
    },
    {
      "sender": "Yash Botadra",
      "user_id": "U02QEPQ1M7U",
      "message": "Just discussed this with Victor but init-upon-email-verification might miss users signing up via Google auth too, which is a big deal.",
      "time": "16:40",
      "timestamp": "1727394010.365059",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "If I move the metronome account creation here, this should cover everything, right? https://github.com/instabase/instabase/blob/9df66014d7f272b431361de0b86cc0b2f2c40c[…]bserver/webapp/src/py/instabase/webapp/handler/views/account.py (https://github.com/instabase/instabase/blob/9df66014d7f272b431361de0b86cc0b2f2c40c6a/webserver/webapp/src/py/instabase/webapp/handler/views/account.py#L143)",
      "time": "16:42",
      "timestamp": "1727394154.315099",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Yea, this should work",
      "time": "16:46",
      "timestamp": "1727394374.371069",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Another place to do this would be in the endpoint to init trial licenses `api/v2/licenses/trial-license/ai-hub`",
      "time": "16:52",
      "timestamp": "1727394736.162199",
      "is_reply": true
    },
    {
      "sender": "Yash Botadra",
      "user_id": "U02QEPQ1M7U",
      "message": "If we do it in `setup_after_user_creation`, is there is a risk of creating metronome/stripe accounts for users who never complete email verification (i.e. users who ghost us)?",
      "time": "16:57",
      "timestamp": "1727395062.330529",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Yea, I think `api/v2/licenses/trial-license/ai-hub` is a better place. We only init the license after user log in for the exact reason",
      "time": "16:59",
      "timestamp": "1727395160.512749",
      "is_reply": true
    },
    {
      "sender": "Xindi Xu",
      "user_id": "U03FT35MAHF",
      "message": "Cypress license issue update:\nTests using newly created community users won't work for now.\n1. We caught a backend bug. We shouldn't complete setting up the license in the verify email step. Google auth users, org users, users created in Cypress won't go thru this step. We should move it to the create license endpoint, which is called upon the first login + in Cypress script\n2. With this fix, the Cypress pipeline using new community users should work\n3. I put up a PR (https://github.com/instabase/instabase/pull/63170) to for a temp fix by calling the migrate license endpoint. \nMy PR won't resolve the issue for existing PRs. We'll need to manually call `api/v2/licenses/migrate` endpoint to migrate the license.",
      "time": "17:06",
      "timestamp": "1727395591.234989",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "PR here: https://github.com/instabase/instabase/pull/63172",
      "time": "18:06",
      "timestamp": "1727399195.727849",
      "is_reply": true
    },
    {
      "sender": "Serena",
      "user_id": "U01CZ3LBFU4",
      "message": "i force-merged Xindi’s PR (https://github.com/instabase/instabase/pull/63170)! so Cypress CI should be unblocked for at least new PRs now",
      "time": "22:27",
      "timestamp": "1727414876.244569",
      "is_reply": true
    },
    {
      "sender": "Victor Zeng",
      "user_id": "U03JT46AUPP",
      "message": "@mfichman can you approve this tomorrow when you get on?",
      "time": "22:29",
      "timestamp": "1727414948.586339",
      "is_reply": true
    }
  ],
  "metadata": {
    "channel_id": "CSY11CK7T",
    "channel_name": "discuss-frontend",
    "date_file": "2024-09-26.json",
    "message_count": 44,
    "start_time": "1727372102.301369",
    "end_time": "1727414948.586339",
    "is_thread": true
  }
}