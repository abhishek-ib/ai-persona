{
  "id": "ch_C06FA6A23_2024-07-31_1722432213.905949_thread",
  "type": "channel",
  "channel_name": "discuss-engineering",
  "conversation_type": "thread",
  "participants": [
    "mfichman",
    "Vasu"
  ],
  "messages": [
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "Having a `mypy` error on the 24.01 release branch in CI that doesn't make any sense (https://github.com/instabase/instabase/pull/60594). This is critical for <#C06CDUM9BLP|>. Can I get a Python or build/mypy expert to take a look ASAP?\n\nThe error  (https://jenkins.instabase.com/blue/rest/organizations/jenkins/pipelines/instabase/branches/PR-60594/runs/1/nodes/27/steps/40/log/?start=0)is here:\n\n```[2024-07-30T21:07:54.716Z] [1,914 / 1,916] Type-checking @//shared-utils/py-utils/thriftstats-utils/test/unit/py/instabase/stats/thrift:test; 4s remote-cache, processwrapper-sandbox ... (4 actions running)\n[2024-07-30T21:07:54.716Z] ERROR: /instabase_dir/shared-utils/py-utils/thriftstats-utils/test/unit/py/instabase/stats/thrift/BUILD.bazel:4:11: Type-checking @//shared-utils/py-utils/thriftstats-utils/test/unit/py/instabase/stats/thrift:test failed: (Exit 1): test_mypy_exe failed: error executing command (from target //shared-utils/py-utils/thriftstats-utils/test/unit/py/instabase/stats/thrift:test) bazel-out/k8-fastbuild/bin/shared-utils/py-utils/thriftstats-utils/test/unit/py/instabase/stats/thrift/test_mypy_exe\n[2024-07-30T21:07:54.716Z] \n[2024-07-30T21:07:54.716Z] Use --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root for debugging\n[2024-07-30T21:07:54.716Z] shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py:504: error: Missing return statement```\nBut if you look at that line of code, (https://github.com/instabase/instabase/pull/60594/files#diff-3ea6ec60ad6db2e0601647c8c91445d59ac2a73eb4507101138b2e47e5005892L504) it doesn't match up at all with the `mypy` error.\n\nI can't reproduce this locally (I get a completely different set of `mypy` errors in my crafting sandbox).\n\nTempted to disable `mypy` entirely on this branch unless we can find a quick resolution here.",
      "time": "06:23",
      "timestamp": "1722432213.905949",
      "is_reply": false
    },
    {
      "sender": "Vasu",
      "user_id": "U02RJRBS13R",
      "message": "Just by taking an initial look, it looks like the nested function `__write_file_stream`  here (https://github.com/instabase/instabase/blob/b7b10b18de476405bc8d8992d97918320cf8b8ff/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py#L504C9-L504C28) doesn't have a return in the main indent level, all the returns seem to be conditionally under try and except blocks. It doesn't make much sense, but I have seen the newer versions of mypy not agreeing with this.",
      "time": "07:25",
      "timestamp": "1722435942.155179",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "The top-level return is here: https://github.com/instabase/instabase/blob/b7b10b18de476405bc8d8992d97918320cf8b8[â€¦]ls/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py (https://github.com/instabase/instabase/blob/b7b10b18de476405bc8d8992d97918320cf8b8ff/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py#L615)",
      "time": "07:30",
      "timestamp": "1722436256.821239",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "Is mypy just broken?",
      "time": "07:31",
      "timestamp": "1722436277.847539",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "Admittedly this code w/ all these nested functions is a mess, but for now we need to tackle the immediate problem of getting these additional logging statements into an image that BofA can use to debug their system.",
      "time": "07:32",
      "timestamp": "1722436321.335479",
      "is_reply": true
    },
    {
      "sender": "Vasu",
      "user_id": "U02RJRBS13R",
      "message": "The return you linked above is the return for the outermost function `_write_file_stream` , whereas the return for the nested function `__write_file_stream` I can't seem to locate in the code :thinking_face:",
      "time": "07:36",
      "timestamp": "1722436615.684259",
      "is_reply": true
    },
    {
      "sender": "Vasu",
      "user_id": "U02RJRBS13R",
      "message": "It's expecting each nested function to have a return statement on it's own top indent level in case any conditional return doesn't get triggered, kind of like a default return I think.",
      "time": "07:38",
      "timestamp": "1722436686.493609",
      "is_reply": true
    },
    {
      "sender": "Vasu",
      "user_id": "U02RJRBS13R",
      "message": "Adding a `return None, None` here (https://github.com/instabase/instabase/blob/b7b10b18de476405bc8d8992d97918320cf8b8ff/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py#L592) at the level of the except block here (https://github.com/instabase/instabase/blob/b7b10b18de476405bc8d8992d97918320cf8b8ff/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py#L587) should help",
      "time": "07:46",
      "timestamp": "1722437201.829949",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "Ah OK. It's odd though b/c we didn't change that; just added some log lines. I'll give that a try. Thanks for the extra :eyes:",
      "time": "09:25",
      "timestamp": "1722443144.419949",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "```diff --git a/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py b/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py\nindex 26f3f950282..e5bb77bd480 100644\n--- a/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py\n+++ b/shared-utils/py-utils/rpc-utils/src/py/instabase/utils/rpc/file_client.py\n@@ -584,12 +584,15 @@ class ThriftGRPCFileClient(ThriftClient):\n         logging.error(\n             f'Unexpected generator exit during __write_stream thread on path {treq.tfile.path}'\n         )\n+        return None, None\n       except Exception as e:\n         logging.info (http://logging.info)(\n             f'Unexpected exception during __write_stream thread on path: {treq.tfile.path}'\n         )\n         return None, f'Unexpected exception when reading {treq.tfile.path}: {str(e)}'```",
      "time": "09:27",
      "timestamp": "1722443224.621269",
      "is_reply": true
    },
    {
      "sender": "mfichman",
      "user_id": "U03DZ9XUE10",
      "message": "Tricky. Thanks!",
      "time": "09:27",
      "timestamp": "1722443228.367699",
      "is_reply": true
    }
  ],
  "metadata": {
    "channel_id": "C06FA6A23",
    "channel_name": "discuss-engineering",
    "date_file": "2024-07-31.json",
    "message_count": 11,
    "start_time": "1722432213.905949",
    "end_time": "1722443228.367699",
    "is_thread": true
  }
}